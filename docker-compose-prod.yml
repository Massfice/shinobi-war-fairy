version: '3'

services:
    entrypoint:
        build:
            context: ./entrypoint
        ports:
            - '80:80'
        depends_on:
            - app
            - api

    app:
        build:
            context: ./app

    api:
        build:
            context: ./api/prod

    subforum-api:
        build:
            context: ./subforum-api
            dockerfile: prod.Dockerfile

    discord-bot-api:
        build:
            context: ./discord-bot-api
            dockerfile: prod.Dockerfile
        environment:
            - BOT_TOKEN=${DISCORD_BOT_TOKEN}

    forum-db:
        image: 'docker.io/bitnami/mariadb:10.3-debian-10'
        environment:
            - ALLOW_EMPTY_PASSWORD=yes
            - MARIADB_USER=bn_phpbb
            - MARIADB_DATABASE=bitnami_phpbb
            - BITNAMI_DEBUG=true
        # volumes:
        #     - 'mariadb_data:/bitnami/mariadb'
        expose:
            - 3306
        restart: always
    forum-staging:
        # image: 'docker.io/bitnami/phpbb:3-debian-10'
        build:
            context: ./forum-staging
        environment:
            - PHPBB_DATABASE_HOST=forum-db
            - PHPBB_DATABASE_PORT_NUMBER=3306
            - PHPBB_DATABASE_USER=bn_phpbb
            - PHPBB_DATABASE_NAME=bitnami_phpbb
            - ALLOW_EMPTY_PASSWORD=yes
        # volumes:
        #     - 'phpbb_data:/bitnami/phpbb'
        depends_on:
            - forum-db
volumes:
    mariadb_data:
        driver: local
    phpbb_data:
        driver: local
